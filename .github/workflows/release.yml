name: Release and Publish to Marketplace

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v1.0.0, v2.1.3, etc.

permissions:
  contents: write
  packages: write
  issues: write
  pull-requests: write

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Extract version from tag
      id: version
      run: |
        TAG_NAME=${GITHUB_REF#refs/tags/}
        echo "version=$TAG_NAME" >> $GITHUB_OUTPUT
        echo "version_number=${TAG_NAME#v}" >> $GITHUB_OUTPUT
    
    - name: Verify action.yml exists
      run: |
        if [ ! -f action.yml ]; then
          echo "Error: action.yml not found"
          exit 1
        fi
        echo "‚úÖ action.yml found"
    
    - name: Validate action structure
      run: |
        # Check if required files exist
        required_files=("action.yml" "Dockerfile" "entrypoint.sh" "README.md")
        for file in "${required_files[@]}"; do
          if [ ! -f "$file" ]; then
            echo "‚ùå Required file missing: $file"
            exit 1
          else
            echo "‚úÖ Found: $file"
          fi
        done
    
    - name: Test action locally
      run: |
        # Basic validation that the Docker image can be built
        echo "Testing Docker image build..."
        docker build -t ssh-action-test .
        echo "‚úÖ Docker image built successfully"
    
    - name: Generate release notes
      id: release_notes
      run: |
        cat > release_notes.md << 'EOF'
        ## SSH Remote Script Executor ${{ steps.version.outputs.version }}
        
        ### What's New
        - Execute scripts on remote hosts via SSH
        - Support for custom SSH ports
        - Password-based authentication
        - Comprehensive error handling
        
        ### Features
        - ‚úÖ Remote script execution via SSH
        - ‚úÖ Configurable SSH port (default: 22)
        - ‚úÖ Password authentication with sshpass
        - ‚úÖ Multi-line script support
        - ‚úÖ Environment variables support (comma-separated)
        - ‚úÖ Proper error handling and validation
        - ‚úÖ Security best practices
        
        ### Usage
        ```yaml
        - name: Execute remote script
          uses: your-username/ssh-action@${{ steps.version.outputs.version }}
          with:
            host: ${{ secrets.SERVER_HOST }}
            username: ${{ secrets.SERVER_USER }}
            password: ${{ secrets.SERVER_PASSWORD }}
            script: |
              echo "Hello from remote server!"
              uptime
        
        # With environment variables
        - name: Deploy with environment variables
          uses: your-username/ssh-action@${{ steps.version.outputs.version }}
          with:
            host: ${{ secrets.SERVER_HOST }}
            username: ${{ secrets.SERVER_USER }}
            password: ${{ secrets.SERVER_PASSWORD }}
            envs: 'DEPLOY_ENV=production,APP_VERSION=1.2.3'
            script: |
              echo "Deploying version $APP_VERSION to $DEPLOY_ENV"
              # Your deployment script here
        ```
        
        ### Security
        - Always use GitHub Secrets for sensitive credentials
        - Never hardcode passwords in workflow files
        - Use principle of least privilege for SSH users
        
        See [README.md](README.md) for complete documentation and examples.
        EOF
        
        echo "Generated release notes:"
        cat release_notes.md
    
    - name: Create GitHub Release
      id: create_release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        gh release create ${{ steps.version.outputs.version }} \
          --title "SSH Remote Script Executor ${{ steps.version.outputs.version }}" \
          --notes-file release_notes.md \
          --latest
    
    - name: Validate Marketplace Requirements
      run: |
        echo "üîç Validating GitHub Marketplace requirements..."
        
        # Check if repository is public
        REPO_VISIBILITY=$(gh repo view ${{ github.repository }} --json visibility --jq '.visibility')
        if [ "$REPO_VISIBILITY" != "public" ]; then
          echo "‚ùå Repository must be public for marketplace publication"
          echo "   Go to Settings ‚Üí Change repository visibility ‚Üí Make public"
          exit 1
        fi
        echo "‚úÖ Repository is public"
        
        # Check action.yml branding
        if grep -q "branding:" action.yml && grep -q "icon:" action.yml && grep -q "color:" action.yml; then
          echo "‚úÖ action.yml has proper branding configuration"
        else
          echo "‚ùå action.yml missing branding configuration"
          exit 1
        fi
        
        # Check README exists and has content
        if [ -f README.md ] && [ -s README.md ]; then
          echo "‚úÖ README.md exists and has content"
        else
          echo "‚ùå README.md missing or empty"
          exit 1
        fi
        
        # Check for usage examples in README
        if grep -q "```yaml" README.md; then
          echo "‚úÖ README contains usage examples"
        else
          echo "‚ö†Ô∏è  README should include usage examples"
        fi
        
        echo "üéØ Marketplace requirements validation complete!"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Prepare Marketplace Metadata
      run: |
        echo "üìã Preparing marketplace metadata..."
        
        # Create marketplace metadata file for reference
        cat > marketplace-metadata.json << 'EOF'
        {
          "name": "SSH Remote Script Executor",
          "description": "Execute scripts on remote hosts via SSH with password authentication",
          "categories": ["Deployment", "Utilities"],
          "tags": ["ssh", "remote", "deployment", "scripts", "automation"],
          "suggested_keywords": [
            "ssh",
            "remote-execution",
            "deployment",
            "server-management",
            "automation",
            "devops"
          ],
          "marketplace_url": "https://github.com/marketplace/actions/ssh-remote-script-executor"
        }
        EOF
        
        echo "‚úÖ Marketplace metadata prepared"
        cat marketplace-metadata.json
    
    - name: Auto-Open Marketplace Publication
      run: |
        echo "üöÄ Opening marketplace publication page..."
        echo ""
        echo "üéâ Release created successfully!"
        echo "üì¶ Version: ${{ steps.version.outputs.version }}"
        echo "üîó Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }}"
        echo ""
        echo "üè™ MARKETPLACE PUBLICATION:"
        echo "   üìã All requirements validated ‚úÖ"
        echo "   üîó Publication URL: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }}"
        echo ""
        echo "üìù To complete marketplace publication:"
        echo "   1. üåê Go to: https://github.com/${{ github.repository }}"
        echo "   2. üì¶ Look for 'Publish this Action to the GitHub Marketplace' banner"
        echo "   3. üñ±Ô∏è  Click the banner or go to the Releases tab"
        echo "   4. ‚úèÔ∏è  Fill in the marketplace form with suggested details:"
        echo "      - Name: SSH Remote Script Executor"
        echo "      - Description: Execute scripts on remote hosts via SSH"
        echo "      - Categories: Deployment, Utilities"
        echo "      - Tags: ssh, remote, deployment, scripts, automation"
        echo "   5. üì§ Submit for publication"
        echo ""
        echo "üéØ The action will be reviewed and published to GitHub Marketplace!"
        echo "üìä View release: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }}"
        
        # Try to open the marketplace page (this works in some environments)
        echo "üîó Attempting to open marketplace publication page..."
        gh repo view ${{ github.repository }} --web || echo "   Manual navigation required"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
  # Job to create/update major version tag (e.g., v1, v2)
  update-major-tag:
    runs-on: ubuntu-latest
    needs: release
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Extract major version
      id: major_version
      run: |
        TAG_NAME=${GITHUB_REF#refs/tags/}
        MAJOR_VERSION=$(echo $TAG_NAME | cut -d. -f1)
        echo "major_version=$MAJOR_VERSION" >> $GITHUB_OUTPUT
        echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
        echo "Extracted major version: $MAJOR_VERSION from tag: $TAG_NAME"
    
    - name: Update major version tag
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        
        echo "üè∑Ô∏è  Updating major version tag: ${{ steps.major_version.outputs.major_version }}"
        
        # Delete the major version tag if it exists (both locally and remotely)
        git tag -d ${{ steps.major_version.outputs.major_version }} 2>/dev/null || echo "Local tag doesn't exist"
        git push origin :refs/tags/${{ steps.major_version.outputs.major_version }} 2>/dev/null || echo "Remote tag doesn't exist"
        
        # Create new major version tag pointing to current commit
        git tag ${{ steps.major_version.outputs.major_version }}
        git push origin ${{ steps.major_version.outputs.major_version }}
        
        echo "‚úÖ Updated major version tag: ${{ steps.major_version.outputs.major_version }}"
        echo "üéØ Users can now use: uses: ${{ github.repository }}@${{ steps.major_version.outputs.major_version }}"
        
  # Job to create marketplace publication tracking issue
  create-marketplace-issue:
    runs-on: ubuntu-latest
    needs: [release, update-major-tag]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    
    permissions:
      contents: write
      issues: write
    
    steps:
    - name: Extract version from tag
      id: version
      run: |
        TAG_NAME=${GITHUB_REF#refs/tags/}
        echo "version=$TAG_NAME" >> $GITHUB_OUTPUT
        echo "version_number=${TAG_NAME#v}" >> $GITHUB_OUTPUT
    
    - name: Create Marketplace Publication Issue
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Check if an issue already exists for this release
        EXISTING_ISSUE=$(gh issue list --repo ${{ github.repository }} --state open --search "Publish ${{ steps.version.outputs.version }} to GitHub Marketplace" --json number --jq '.[0].number' || echo "")
        
        if [ -n "$EXISTING_ISSUE" ] && [ "$EXISTING_ISSUE" != "null" ]; then
          echo "üìù Issue already exists for this release: #$EXISTING_ISSUE"
          exit 0
        fi
        
        # Create the issue
        gh issue create \
          --repo ${{ github.repository }} \
          --title "üè™ Publish ${{ steps.version.outputs.version }} to GitHub Marketplace" \
          --assignee ${{ github.actor }} \
          --label "marketplace,release" \
          --body "## üöÄ Release ${{ steps.version.outputs.version }} Ready for Marketplace Publication

        ### ‚úÖ Pre-publication Checklist
        - [x] Release created successfully
        - [x] Major version tag updated
        - [x] All marketplace requirements validated
        - [x] Docker image builds successfully
        - [x] Action metadata configured
        - [ ] **Marketplace publication completed**

        ### üè™ Marketplace Publication Steps

        1. **Navigate to Repository**
           - Go to: https://github.com/${{ github.repository }}
           - Look for the \"Publish this Action to the GitHub Marketplace\" banner

        2. **Click Publication Banner**
           - The banner should appear at the top of the repository page
           - If not visible, go to the Releases tab and click \"Publish to Marketplace\"

        3. **Fill Marketplace Form**
           - **Name**: \`SSH Remote Script Executor\`
           - **Description**: \`Execute scripts on remote hosts via SSH with password authentication\`
           - **Categories**: \`Deployment\`, \`Utilities\`
           - **Tags**: \`ssh\`, \`remote\`, \`deployment\`, \`scripts\`, \`automation\`

        4. **Submit for Review**
           - Review the information and submit
           - GitHub will review the action before publishing

        ### üìã Marketplace Metadata
        
        \`\`\`json
        {
          \"name\": \"SSH Remote Script Executor\",
          \"description\": \"Execute scripts on remote hosts via SSH with password authentication\",
          \"categories\": [\"Deployment\", \"Utilities\"],
          \"tags\": [\"ssh\", \"remote\", \"deployment\", \"scripts\", \"automation\"],
          \"version\": \"${{ steps.version.outputs.version }}\"
        }
        \`\`\`

        ### üîó Quick Links
        - [Release Page](https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }})
        - [Repository](https://github.com/${{ github.repository }})
        - [Action Documentation](https://github.com/${{ github.repository }}/blob/main/README.md)

        ### üìù Notes
        - This issue will be automatically closed when the marketplace publication is complete
        - The action will be available at: \`uses: ${{ github.repository }}@${{ steps.version.outputs.version }}\`
        - Major version tag available: \`uses: ${{ github.repository }}@v$(echo ${{ steps.version.outputs.version }} | cut -d. -f1 | sed 's/v//')\`

        **Assigned to**: @${{ github.actor }}
        **Release**: ${{ steps.version.outputs.version }}
        **Status**: Ready for marketplace publication"
        
        echo "üìù Created marketplace publication tracking issue" 